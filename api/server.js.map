{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./scripts/commands.ts","webpack:///external \"mongoose\"","webpack:///./scripts/__utils.ts","webpack:///./models/constants.ts","webpack:///./scripts/bot.ts","webpack:///./server.ts","webpack:///external \"express\"","webpack:///external \"body-parser\"","webpack:///./models/schemas.ts","webpack:///external \"chalk\"","webpack:///external \"minimist\"","webpack:///external \"node-telegram-bot-api\"","webpack:///./scripts/booru.ts","webpack:///external \"danbooru\"","webpack:///external \"https\"","webpack:///external \"fs\"","webpack:///./core.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","dansole","DanConsole","danUtils","DanUtils","danMemory","DanMemory","mongoose","bot","getPostsInfo","setCommand","CHANNEL_ID","process","env","c_start","msg","chatId","chat","id","getUpdates","then","sendMessage","reply_markup","resize_keyboard","one_time_keyboard","keyboard","text","c_hello","e","error","c_echo","console","log","c_info","res","info","flattenArrayOfObjects","botChatId","join","settings","getAll","keys","length","concat","JSON","stringify","c_link","posts","rando","Math","floor","random","file_url","c_pic","sendPhoto","c_post","refreshPosts","postPreferences","_posts","sort","post","prevPost","up_score","sortedPosts","selectedPostIndex","postsRefreshedCounter","getCollectionName","tag_string_artist","split","isPostInDB","_selectedPost","collectionName","selectedPost","model","MPost","find","md5","substr","map","_doc","selectPost","isNewPost","modelDocument","url","added_at","Date","toUTCString","tags","tag_string","artists","save","err","large_file_url","caption","file_ext","preferences","LIMIT_FOR_TAGS","c_set","parameters","parseCommand","c_help","allowedParams","set","require","chalk","minimist","enableLogs","title","bgRed","black","message","args","shift","Error","stackLogs","stack","red","trim","warn","this","bgYellow","yellow","bgCyan","cyan","array","reduce","acc","val","Array","isArray","temp","valKey","push","string","command","base","parameter","lastSetting","parKey","DAN_SETTING","parse","EXCLUDED_TAGS","TRANSLATED_TAGS_RU","BOT_TOKEN","polling","DATABASE_URL","DB_USERNAME","DB_PASSWORD","DB_SHARDS","DB_NAME","connect","useUnifiedTopology","useNewUrlParser","db","connection","on","once","express","bodyParser","app","use","json","urlencoded","extended","req","path","body","telegram_url","chat_id","response","status","end","tryToExecuteCommand","send","listen","PORT","MongoSavedPost","Schema","String","Danbooru","https","fs","booru","saveFile","files","readdirSync","filesCount","forEach","fileName","filter","file","pipe","createWriteStream","dir","params","postParams","paramsArray","paramsKey","limit","success","getPostsFileStream","NTBA_FIX_319","callback","isArguments","regExp","RegExp","onText"],"mappings":"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","file":"server.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n","// set of all bot commands\r\n\r\n\r\nimport {IDanPost} from \"../models/danbooru\";\r\nimport {MPost} from \"../models/schemas\";\r\nimport {DanConsole, DanMemory, DanUtils} from \"./__utils\";\r\nimport {LIMIT_FOR_TAGS} from \"../models/constants\";\r\nimport { ITelegramMessage, ITelegramUpdateResponse } from \"../models/telegram\";\r\nimport { IMongoFindResponse } from \"../models/mongo\";\r\nimport { IncomingMessage } from \"http\";\r\n\r\nconst dansole = new DanConsole(true);\r\nconst danUtils = new DanUtils();\r\nconst danMemory = new DanMemory();\r\n\r\n\r\nconst mongoose = require('mongoose');\r\nconst {bot} = require('./bot');\r\nconst {getPostsInfo} = require('./booru');\r\nconst {setCommand} = require('../core');\r\n\r\nconst CHANNEL_ID = process.env.CHANNEL_ID;\r\n\r\n/**\r\n * shows keyboard\r\n * also this is INITIAL COMMAND (runs on start)\r\n */\r\nfunction c_start(msg: ITelegramMessage) {\r\n    const chatId = msg.chat.id;\r\n    bot.getUpdates().then(() => {\r\n        bot.sendMessage(chatId, 'Thank you for visiting our hub!', {\r\n            reply_markup: {\r\n                resize_keyboard: true,\r\n                one_time_keyboard: false,\r\n                keyboard: [\r\n                    [{text: '\\/help'}],\r\n                    [{text: '\\/info'}, {text: '\\/pic'}],\r\n                    [{text: '\\/post'}],\r\n                ],\r\n            },\r\n        });\r\n    })\r\n}\r\n\r\n/**\r\n * prints static message\r\n */\r\nfunction c_hello(msg: ITelegramMessage) {\r\n    const chatId = msg.chat.id;\r\n    bot.sendMessage(chatId, 'Hello there!').catch((e: IncomingMessage) => dansole.error(e));\r\n}\r\n\r\n/**\r\n * prints received text\r\n */\r\nfunction c_echo(msg: ITelegramMessage) {\r\n    console.log(\"echoing \", msg.text);\r\n    console.log(\"whole object \", msg);\r\n\r\n    const chatId = msg.chat.id;\r\n    bot.sendMessage(chatId, `You said: ${msg.text}`).catch((e: IncomingMessage) => console.error(e));\r\n    console.log(\"After message sent ... \");\r\n}\r\n\r\n/**\r\n * prints general information:\r\n *  botId\r\n */\r\nfunction c_info(msg: ITelegramMessage) {\r\n    const chatId = msg.chat.id;\r\n    bot.getUpdates().then((res: Array<ITelegramUpdateResponse>) => {\r\n        const botInfoObj = danUtils.flattenArrayOfObjects([\r\n            { botChatId: chatId},\r\n            res\r\n        ]);\r\n\r\n        let info = botInfoObj.join(`; \\n`);\r\n\r\n        const settings = danMemory.getAll();\r\n\r\n        if (Object.keys(settings).length) {\r\n            info = info.concat(`\\n\\nSettings: \\n${JSON.stringify(settings)}`)\r\n        }\r\n\r\n        dansole.info(info, settings);\r\n\r\n        bot.sendMessage(chatId, info).catch((e: IncomingMessage) => dansole.error(e))\r\n    });\r\n}\r\n\r\n/**\r\n * sends a random picture link\r\n */\r\nasync function c_link(msg: ITelegramMessage) {\r\n    const chatId = msg.chat.id;\r\n    bot.sendMessage(chatId, 'Getting you a link ...').catch((e: IncomingMessage) => dansole.error(e));\r\n    const posts: Array<IDanPost> = await getPostsInfo();\r\n    const rando = posts[Math.floor(Math.random()*posts.length)];\r\n    await bot.sendMessage(chatId, rando.file_url).catch((e: IncomingMessage) => dansole.error(e));\r\n}\r\n\r\n/**\r\n * sends a random picture\r\n */\r\nasync function c_pic(msg: ITelegramMessage) {\r\n    const chatId = msg.chat.id;\r\n    bot.sendMessage(chatId, 'Getting you a picture ...').catch((e: IncomingMessage) => dansole.error(e));\r\n    const posts: Array<IDanPost> = await getPostsInfo();\r\n    const rando = posts[Math.floor(Math.random()*posts.length)];\r\n    await bot.sendPhoto(msg.chat.id, rando.file_url).catch((e: IncomingMessage) => dansole.error(e))\r\n}\r\n\r\n/**\r\n * posts picture to channel\r\n */\r\nasync function c_post(msg: ITelegramMessage) {\r\n    const chatId = msg.chat.id;\r\n    let selectedPostIndex: number = 0;\r\n    let postsRefreshedCounter: number = 0;  // debug info (for report)\r\n    let selectedPost: IDanPost;\r\n    // let posts: Array<IDanPost> = [];\r\n    let sortedPosts: Array<IDanPost> = [];\r\n    const postPreferences = danMemory.getAll();\r\n\r\n    // let collectionName: string;\r\n    // let modelDocument;\r\n\r\n    function sortByScore(posts: Array<IDanPost>): Array<IDanPost> {\r\n        return posts.sort(((post, prevPost) => {\r\n            return prevPost.up_score - post.up_score\r\n        }))\r\n    }\r\n\r\n    // pulls a pack of 20 posts and sorts them\r\n    async function refreshPosts() {\r\n        // [1] getting pack of posts\r\n        const _posts = await getPostsInfo(postPreferences);\r\n        // [2] sorting by best (higher up score)\r\n        sortedPosts = await sortByScore(_posts);\r\n\r\n        selectedPostIndex = 0;\r\n        postsRefreshedCounter++;\r\n    }\r\n\r\n    const selectPost = (_posts: Array<IDanPost>): IDanPost => {\r\n        if (selectedPostIndex === _posts.length - 1) {\r\n            refreshPosts();\r\n        }\r\n\r\n        const _selectedPost = _posts[selectedPostIndex];\r\n        selectedPostIndex++;\r\n\r\n        return _selectedPost;\r\n    };\r\n\r\n    function getCollectionName(post: IDanPost): string {\r\n        if (post.tag_string_artist.length > 0) {\r\n            return post.tag_string_artist.split(' ')[0];\r\n        } else {\r\n            return 'other';\r\n        }\r\n    }\r\n\r\n    function isPostInDB(_selectedPost: IDanPost): Promise<boolean> {\r\n        // [3] checking if was posted before\r\n        const collectionName = getCollectionName(selectedPost);\r\n        const modelDocument = mongoose.model(collectionName, MPost);\r\n\r\n        return modelDocument.find({md5: _selectedPost.md5}).then((res: Array<IMongoFindResponse<IDanPost>>) => {\r\n            dansole.info(`Searching ${selectedPost.md5.substr(-4, 4)} in ${collectionName}`);\r\n            dansole.info(res.length, res.map(r => {\r\n                return (r._doc) ? r._doc.md5.substr(-4, 4) : 'not found!';\r\n            }));\r\n            return res.length > 0;\r\n        }, (e: IncomingMessage) => dansole.error(e));\r\n    }\r\n\r\n    await refreshPosts();\r\n    let isNewPost: boolean = false;\r\n\r\n    do {\r\n        selectedPost = selectPost(sortedPosts);\r\n        isNewPost = await isPostInDB(selectedPost);\r\n\r\n        if (postsRefreshedCounter > 3) {\r\n            bot.sendMessage(chatId, '`WARNING!` Maximum cycle count reached. You need to make search scope wider!').catch((e: IncomingMessage) => dansole.error(e));\r\n            return;\r\n        }\r\n    } while (isNewPost);\r\n\r\n    // [4] saving to DB\r\n    const collectionName = getCollectionName(selectedPost);\r\n    const modelDocument = mongoose.model(collectionName, MPost);\r\n    const dbPost = new modelDocument({\r\n        md5: selectedPost.md5,\r\n        url: selectedPost.file_url,\r\n        added_at: new Date().toUTCString(),\r\n        tags: selectedPost.tag_string,\r\n        artists: selectedPost.tag_string_artist\r\n    });\r\n\r\n    await dbPost.save(function (err: IncomingMessage) {\r\n        if (err) {\r\n            bot.sendMessage(chatId, '`WARNING!` Unable to save post to DB. Post was not posted!').catch((e: IncomingMessage) => dansole.error(e));\r\n            return dansole.error(err);\r\n        }\r\n\r\n        // [5] posting to channel\r\n        bot.sendPhoto(CHANNEL_ID, selectedPost.large_file_url, { caption: `${selectedPost.md5}.${selectedPost.file_ext}` }).then(() => {\r\n            // [6] sending report to owner\r\n            let info = ` \\n\r\n            ✅ Picture ${selectedPost.md5} was posted. \\n \r\n            📋 To collection: ${collectionName}. \\n\r\n            🔁 Cycles performed: ${postsRefreshedCounter}. \\n \r\n            Selected picture from last cycle is #${selectedPostIndex} \\n\r\n            🕓 Posted at: ${new Date().toUTCString()}`;\r\n\r\n            const preferences = danMemory.getAll();\r\n\r\n            if (Object.keys(preferences).length) {\r\n                info = info.concat(` \\n\\n⚙ With preferences: ${JSON.stringify(preferences)} and increased limit to ${LIMIT_FOR_TAGS}`);\r\n            }\r\n\r\n            bot.sendMessage(\r\n                chatId, info\r\n            ).catch((e: IncomingMessage) => dansole.error(e));\r\n        }).catch((e: IncomingMessage) => {\r\n            dansole.error(e);\r\n\r\n            bot.sendMessage(\r\n                chatId, `22\r\n                ❌ Picture ${selectedPost.md5} was NOT posted. \\n \r\n                📋 To collection: ${collectionName}. \\n\r\n                🔁 Cycles performed: ${postsRefreshedCounter}. \\n \r\n                Selected picture from last cycle is #${selectedPostIndex} \\n\r\n                🕓 Error happened at: ${new Date().toUTCString()} \\n\\n\r\n                REASON: ${e} \\n\\n\r\n                \r\n                LOG: ${JSON.stringify(selectedPost)}`\r\n            ).catch((e: IncomingMessage) => dansole.error(e));\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * sets a setting value\r\n */\r\nfunction c_set(msg: ITelegramMessage) {\r\n    const chatId = msg.chat.id;\r\n\r\n    const parameters = danUtils.parseCommand(msg.text).parameters;\r\n\r\n    if (parameters['_'].length) {\r\n        bot.sendMessage(chatId, `Can't perceive this parameters: ${parameters['_'].join(', ')}`);\r\n        c_help(msg);\r\n        return;\r\n    }\r\n\r\n    delete parameters['_'];\r\n\r\n    for (const key in parameters) {\r\n        if (parameters.hasOwnProperty(key) && danMemory.allowedParams.find(name => name === key)) {\r\n            danMemory.set({[key]: parameters[key]});\r\n        } else {\r\n            bot.sendMessage(chatId, `${key} parameter not allowed`);\r\n            c_help(msg);\r\n        }\r\n    }\r\n\r\n    bot.sendMessage(chatId, `Dan preference now: ${JSON.stringify(danMemory.getAll())}`);\r\n}\r\n\r\n/**\r\n * prints help\r\n */\r\nfunction c_help(msg: ITelegramMessage) {\r\n    bot.sendMessage(msg.chat.id, `\r\n        Available commands:\r\n            /start - shows keyboard, starts bot\r\n            /hello - prints message\r\n            /pic - gets random picture\r\n            /post - posts picture to channel based on preferences\r\n            /set - sets preference\r\n                --rating - saves selected rating ['explicit' | 'safe' | 'questionable']; ex: /set --rating=safe\r\n                --order - saves selected order ['rank' | 'custom' | 'comment_bumped']; ex: /set --order=rank\r\n                --frequency - how often post will be posted automatically (in hours);  ex: /set --frequency=1\r\n    `);\r\n}\r\n\r\nsetCommand('set', (msg: ITelegramMessage) => {\r\n    c_set(msg)\r\n}, true);\r\nsetCommand('help', (msg: ITelegramMessage) => {\r\n    c_help(msg)\r\n});\r\nsetCommand('post', (msg: ITelegramMessage) => {\r\n    c_post(msg);\r\n});\r\nsetCommand('pic', (msg: ITelegramMessage) => {\r\n    c_pic(msg);\r\n});\r\nsetCommand('link', (msg: ITelegramMessage) => {\r\n    c_link(msg);\r\n});\r\nsetCommand('hello', (msg: ITelegramMessage) => {\r\n    c_hello(msg);\r\n});\r\nsetCommand('info', (msg: ITelegramMessage) => {\r\n    c_info(msg);\r\n});\r\nsetCommand('start', (msg: ITelegramMessage) => {\r\n    c_start(msg);\r\n});\r\nsetCommand('echo', (msg: ITelegramMessage) => {\r\n    c_echo(msg);\r\n});\r\n\r\nexport {\r\n    c_help,\r\n    c_start,\r\n    c_link,\r\n    c_info,\r\n    c_hello,\r\n    c_pic,\r\n    c_post,\r\n    c_set,\r\n    c_echo\r\n};\r\n","module.exports = require(\"mongoose\");","const chalk = require('chalk');\r\nconst minimist = require('minimist');\r\n\r\nexport class DanConsole {\r\n    public constructor(enableLogs: boolean = false) {\r\n        this.enableLogs = enableLogs;\r\n    }\r\n\r\n    private enableLogs: boolean;\r\n\r\n    public error = function (...args: Array<string | Object>) {\r\n        const title = chalk.bgRed.black('[DAN] >> Error: ');\r\n        const message: any = args.shift();\r\n        const error = new Error(message);\r\n        const stackLogs = error.stack.split('\\n');\r\n        console.error(`\\n\\nLogs: ${error.stack}\\n\\n`)\r\n        console.error(`${title} ${chalk.red(stackLogs[2].trim())} ${error.message}\\n`);\r\n    };\r\n\r\n    public warn = function (...args: Array<string | Object>) {\r\n        if (this.enableLogs) {\r\n            const title = chalk.bgYellow.black('[DAN] >> Warning: ');\r\n            console.warn(title, chalk.yellow(...args));\r\n        }\r\n    };\r\n\r\n    public info = function (...args: Array<string | Object>) {\r\n        if (this.enableLogs) {\r\n            const title = chalk.bgCyan.black('[DAN] >> FYI: ');\r\n            console.info(title, chalk.cyan(...args));\r\n        }\r\n    };\r\n}\r\n\r\nexport class DanUtils {\r\n\r\n    /**\r\n     * Suppose you have Array of objects and you need Array with their values. This function does that\r\n\t *\r\n\t * @param {array} array - An array of any iterable objects to flatten\r\n\t * @returns {array} flattened array of values\r\n     * @example\r\n     *      flattenArrayOfObjects[{.}, {.}, {.}] => [...]\r\n     */\r\n\r\n    public flattenArrayOfObjects(array: Array<{[key:string]: any}>): Array<any> {\r\n        return array.reduce((acc, val) => {\r\n            if (Array.isArray(val)) {\r\n                return acc.concat(this.flattenArrayOfObjects(val));\r\n            } else if (typeof val === 'object') {\r\n                const temp = [];\r\n                for (let valKey in val) {\r\n                    if (typeof val[valKey] === 'object') {\r\n                        return acc.concat(this.flattenArrayOfObjects([val[valKey]]));\r\n                    }\r\n                    temp.push(`${valKey}: ${val[valKey]}`)\r\n                }\r\n                return acc.concat(temp)\r\n            } else {\r\n                return acc.concat(val)\r\n            }\r\n        }, []);\r\n    }\r\n\r\n\r\n    public parseCommand(string: string) {\r\n        const command = string.split(' ');\r\n        const base = command.shift();\r\n\r\n        return {\r\n            base,\r\n            parameters: minimist(command)\r\n        }\r\n    }\r\n}\r\n\r\nexport class DanMemory {\r\n    public allowedParams = ['rating', 'order', 'frequency'];\r\n\r\n    public set(parameter: {[key: string]: string}): void {\r\n        const lastSetting = this.getAll();\r\n        const parKey = Object.keys(parameter)[0];\r\n        console.log('Saving: ', parKey, parameter[parKey]);\r\n\r\n        process.env.DAN_SETTING = JSON.stringify({\r\n            ...lastSetting,\r\n            [parKey]: parameter[parKey]\r\n        });\r\n    }\r\n\r\n    public get(value: string): string {\r\n        return JSON.parse(process.env.DAN_SETTING)[value];\r\n    }\r\n\r\n    public getAll(): {[key: string]: string} {\r\n        console.log('Getting all: ', process.env.DAN_SETTING);\r\n        return process.env.DAN_SETTING? JSON.parse(process.env.DAN_SETTING) : {};\r\n    }\r\n}\r\n\r\n\r\n","export const EXCLUDED_TAGS = [\r\n    'gay', 'gore', 'yaoi', 'male_masturbation', 'male_pubic_hair', 'multiple_boys', 'otoko_no_ko'\r\n];\r\n\r\nexport const TRANSLATED_TAGS_RU = {\r\n\r\n};\r\n\r\n// when tags such as {rating: 'safe'} is added to search, limit should be increased\r\nexport const LIMIT_FOR_TAGS = 100;\r\n","// [ BOT CONFIG ]\r\n\r\nconst TelegramBot = require('node-telegram-bot-api');\r\nconst token = process.env.BOT_TOKEN;\r\nconst bot = new TelegramBot(token, {polling: true});\r\n\r\n// @ToDo Separate this bitch into two modules\r\n\r\n// [ DB CONFIG ]\r\n\r\nconst DATABASE_URL = `mongodb+srv://${process.env.DB_USERNAME}:${process.env.DB_PASSWORD}@${process.env.DB_SHARDS}/${process.env.DB_NAME}?retryWrites=true&w=majority`;\r\nconst mongoose = require('mongoose');\r\n// connecting DB to env variable\r\nmongoose.connect(DATABASE_URL, {useUnifiedTopology: true, useNewUrlParser: true}).catch((error: Error) => {\r\n  console.error(`[DAN] >> Error: failed to connect to Mongo DB! \\n`, error);\r\n});\r\n\r\n// accessing connection to DB\r\nconst db = mongoose.connection;\r\n\r\ndb.on('error', (error: Error) => console.error(`[DAN] >> Error: Mongo DB failed \\n`, error));\r\ndb.once('open', () => console.info('Connected to Mongoose DB!'));\r\n\r\nmodule.exports = {bot, db};\r\n\r\n\r\n","const express = require(\"express\");\r\nconst bodyParser = require('body-parser');\r\nconst app = express();\r\n\r\nrequire('./scripts/commands');\r\n\r\nimport {\r\n    c_help,\r\n    c_echo,\r\n    c_start,\r\n    c_hello\r\n} from \"./scripts/commands\";\r\n\r\napp.use(bodyParser.json());\r\napp.use(bodyParser.urlencoded({\r\n  extended: true\r\n}));\r\n\r\napp.post(\"/api/server\", function(req: any, res: any) {\r\n  console.log(\"req.path\", req.path);\r\n\r\n  if (req.body) {\r\n    const { message } = req.body;\r\n    tryToExecuteCommand(message);\r\n  }\r\n  res.send('Hello from /api/server!');\r\n});\r\n\r\napp.listen(process.env.PORT || 5000, () => console.log(`Telegram bot is listening on port ${process.env.PORT || 5000}!`));\r\n\r\nfunction tryToExecuteCommand(msg: any): void {\r\n    console.log('Received Text: ', msg.text)\r\n    switch(msg.text) {\r\n      case '/hello':\r\n        c_hello(msg);\r\n        break;\r\n      case '/start':\r\n        c_start(msg);\r\n        break;\r\n      case '/echo':\r\n        let telegram_url = \"https://api.telegram.org/bot\" + process.env.BOT_TOKEN +\"/sendMessage\";\r\n\r\n        console.log(\"Sending message to bot nativelly!\", telegram_url);\r\n\r\n        app.post(telegram_url, {\r\n          chat_id: msg.chat.id,\r\n          text: `You said: ${msg.text}`\r\n        }).then((response: any) => {\r\n            console.log(\"Message posted\");\r\n            response.status(200).end(\"ok\");\r\n        }).catch((error: any) =>{\r\n            console.error(\"UPERSERIOUS ERROR OCCURED\", error);\r\n        });\r\n        console.log(\"executing c_echo ....\");\r\n        c_echo(msg);\r\n\r\n\r\n\r\n        break;\r\n      default:\r\n        console.log('Unable to recognise command!');\r\n    }\r\n}\r\n","module.exports = require(\"express\");","module.exports = require(\"body-parser\");","const mongoose = require('mongoose');\r\n\r\nconst MongoSavedPost = new mongoose.Schema({\r\n    md5: String,\r\n    url: String,\r\n    added_at: String,\r\n    tags: String,\r\n    artists: String\r\n});\r\n\r\nexport const MPost = MongoSavedPost;\r\n","module.exports = require(\"chalk\");","module.exports = require(\"minimist\");","module.exports = require(\"node-telegram-bot-api\");","import {IDanPost, IDanPostError, TDanOrder, TDanRatings} from \"../models/danbooru\";\r\nimport {ClientRequest, IncomingMessage} from \"http\";\r\nimport {DanConsole} from \"./__utils\";\r\nimport {LIMIT_FOR_TAGS} from \"../models/constants\";\r\nimport { Dirent } from \"fs\";\r\nimport { Http2ServerResponse } from \"http2\";\r\nconst dansole = new DanConsole(true);\r\n\r\nconsole.log('[DAN] >> Starting booru.js ...');\r\n\r\nconst Danbooru = require('danbooru');\r\nconst https = require('https');\r\nconst fs = require('fs');\r\n\r\n// Perform a search for popular image posts\r\nconst booru = new Danbooru();\r\n\r\nfunction TEST(do_save: boolean = false): void {\r\n  booru.posts({tags: 'rating:safe order:rank'}).then((posts: Array<IDanPost>) => {\r\n    // Select a random post from posts array\r\n    const index = Math.floor(Math.random() * posts.length);\r\n    const post = posts[index];\r\n\r\n    console.log('Link: ', post.large_file_url);\r\n\r\n    if (do_save){\r\n      saveFile([post]);\r\n    }\r\n  });\r\n}\r\n\r\nfunction getPostsInfo(params?: {\r\n  rating?: TDanRatings,\r\n  order?: TDanOrder\r\n}): Array<IDanPost> {\r\n  let postParams;\r\n  if (params) {\r\n    let paramsArray: Array<string> = [];\r\n\r\n    for (let paramsKey in params) {\r\n      paramsArray.push(`${paramsKey}:${params[paramsKey as 'rating' | 'order']}`);\r\n    }\r\n\r\n    postParams = {tags: paramsArray.join(' '), limit: LIMIT_FOR_TAGS};\r\n    dansole.info(`Parameters for searching: `);\r\n    console.dir(postParams);\r\n  } else {\r\n    dansole.warn(`[DAN] >> @getFile(): getting random picture ...`)\r\n  }\r\n\r\n  return booru.posts(postParams).then((res: Array<IDanPost>) => {\r\n\r\n    // sometimes res can be as Error: IDanPostError. If so must throw exception\r\n    if ((res as unknown as IDanPostError).success === false) {\r\n      dansole.error(`[DAN] >> Error @getFile(): ${(res as unknown as IDanPostError).message}`);\r\n      return;\r\n    }\r\n    return res;\r\n  });\r\n}\r\n\r\nfunction getPostsFileStream(posts: Array<IDanPost>): Array<ClientRequest> {\r\n  return posts.map(post => {\r\n    // Get post's url and create a filename for it\r\n    const url = booru.url(post.file_url);\r\n    // Download post image using node's https and fs libraries\r\n    return https.get(url).on('error', (err: IncomingMessage) => { console.log(err) });\r\n  })\r\n}\r\n\r\n/**\r\n * Saves file to ./saves.\r\n * @param {Array<IDanPost>} posts array of posts.\r\n */\r\nfunction saveFile(posts: Array<IDanPost>): void {\r\n  const dir = './saves';\r\n  const files: Array<string | Buffer | Dirent> = fs.readdirSync(dir);\r\n  const filesCount = ++files.length;\r\n\r\n  if (posts && Array.isArray(posts)) {\r\n    posts.forEach(post => {\r\n      const fileName = `${post.md5}.${post.file_ext}`;\r\n      const existing = files.filter(file => file === fileName);\r\n\r\n      if (existing.length) {\r\n        console.warn(`[DAN] >> File \"${fileName}\" already exists! Rewriting.`);\r\n      }\r\n\r\n      console.log(`[DAN] >> Saving file #${filesCount} - \"${fileName}\" ...`);\r\n\r\n      // Get post's url and create a filename for it\r\n      const url = booru.url(post.file_url);\r\n\r\n      // Download post image using node's https and fs libraries\r\n      https.get(url, (response: Http2ServerResponse) => {\r\n        response.pipe(fs.createWriteStream(`${dir}/${fileName}`));\r\n        console.log('The file has been saved!');\r\n      })\r\n    })\r\n  }\r\n}\r\n\r\n\r\n// EXECUTION\r\n\r\nconsole.log('[DAN] >> main() execution...', '\\n\\n\\n');\r\n(async function main () {\r\n\r\n  // TEST();\r\n\r\n  // let postsInfo: Array<IDanPost> = await getPostsInfo({rating: \"explicit\", order: \"rank\"});\r\n\r\n  // console.log(\"GET INFO res: \\n\\n\", postsInfo.length, postsInfo.map(postInfoObj => postInfoObj.file_url));\r\n\r\n  // getPostsFileStream(postsInfo);\r\n\r\n  // console.log(\"GET STREAM res: \\n\\n\", postsStream.length, postsStream.map((postStream, i) => {\r\n  //   return `Stream #${i} is writable: ${postStream.writable}`;\r\n  // }));\r\n\r\n})();\r\n\r\nexport {getPostsInfo, getPostsFileStream, saveFile};\r\n","module.exports = require(\"danbooru\");","module.exports = require(\"https\");","module.exports = require(\"fs\");","// ENTRY POINT (start program from here)\r\n\r\nif (process.env.NODE_ENV !== 'production') {\r\n  // checking if running in production environment.\r\n  // NODE_ENV will be set by node automatically if so\r\n\r\n  // loading dotenv vars to process.env\r\n  require('dotenv').config();\r\n}\r\n\r\nprocess.env.NTBA_FIX_319 = '1';\r\n\r\nimport {DanConsole} from \"./scripts/__utils\";\r\nconst {bot} = require('./scripts/bot');\r\nconst dansole = new DanConsole(true);\r\n\r\n/**\r\n * Suppose you have Array of objects and you need Array with their values. This function does that\r\n *\r\n * @param {string} name - how command can be called\r\n * @param {Function} callback - function of command\r\n * @param {boolean} isArguments - if true command can be followed by argument\r\n * @example\r\n *      newCommand('do_thing --fast', onEvent, true)\r\n */\r\nfunction newCommand(name: string, callback: Function, isArguments: boolean = false): void {\r\n  const regExp = (!isArguments) ? new RegExp(`\\/${name}`) : new RegExp(`\\/${name} (.+)`);\r\n\r\n  bot.onText(regExp, callback);\r\n}\r\n\r\ndansole.info('Core initiated. Loading dependencies ...');\r\n\r\nmodule.exports = {\r\n  setCommand: newCommand\r\n};\r\n\r\n// initiating commands\r\nrequire('./scripts/commands');\r\n"],"sourceRoot":""}