!function(e){var n={};function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(r,o,function(n){return e[n]}.bind(null,o));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=5)}([function(e,n,t){"use strict";var r=this&&this.__awaiter||function(e,n,t,r){return new(t||(t=Promise))((function(o,s){function i(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(i,a)}c((r=r.apply(e,n||[])).next())}))},o=this&&this.__generator||function(e,n){var t,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;i;)try{if(t=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=n.call(e,i)}catch(e){s=[6,e],r=0}finally{t=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};n.__esModule=!0;var s=t(8),i=t(2),a=t(3),c=new i.DanConsole(!0),u=new i.DanUtils,l=new i.DanMemory,f=t(1),d=t(4).bot,p=t(12).getPostsInfo,h=t(16).setCommand,g=process.env.CHANNEL_ID;function v(e){var n=e.chat.id;d.getUpdates().then((function(){d.sendMessage(n,"Thank you for visiting our hub!",{reply_markup:{resize_keyboard:!0,one_time_keyboard:!1,keyboard:[[{text:"/help"}],[{text:"/info"},{text:"/pic"}],[{text:"/post"}]]}})}))}function b(e){var n=e.chat.id;d.sendMessage(n,"Hello there!").catch((function(e){return c.error(e)}))}function y(e){console.log("echoing ",e.text),console.log("whole object ",e);var n=e.chat.id;d.sendMessage(n,"You said: "+e.text).catch((function(e){return console.error(e)})),console.log("After message sent ... ")}function _(e){var n=e.chat.id;d.getUpdates().then((function(e){var t=u.flattenArrayOfObjects([{botChatId:n},e]).join("; \n"),r=l.getAll();Object.keys(r).length&&(t=t.concat("\n\nSettings: \n"+JSON.stringify(r))),c.info(t,r),d.sendMessage(n,t).catch((function(e){return c.error(e)}))}))}function m(e){return r(this,void 0,void 0,(function(){var n,t,r;return o(this,(function(o){switch(o.label){case 0:return n=e.chat.id,d.sendMessage(n,"Getting you a link ...").catch((function(e){return c.error(e)})),[4,p()];case 1:return t=o.sent(),r=t[Math.floor(Math.random()*t.length)],[4,d.sendMessage(n,r.file_url).catch((function(e){return c.error(e)}))];case 2:return o.sent(),[2]}}))}))}function w(e){return r(this,void 0,void 0,(function(){var n,t,r;return o(this,(function(o){switch(o.label){case 0:return n=e.chat.id,d.sendMessage(n,"Getting you a picture ...").catch((function(e){return c.error(e)})),[4,p()];case 1:return t=o.sent(),r=t[Math.floor(Math.random()*t.length)],[4,d.sendPhoto(e.chat.id,r.file_url).catch((function(e){return c.error(e)}))];case 2:return o.sent(),[2]}}))}))}function S(e){return r(this,void 0,void 0,(function(){function n(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return[4,p(_)];case 1:return e=n.sent(),[4,(t=e,t.sort((function(e,n){return n.up_score-e.up_score})))];case 2:return y=n.sent(),h=0,v++,[2]}var t}))}))}function t(e){return e.tag_string_artist.length>0?e.tag_string_artist.split(" ")[0]:"other"}function i(e){var n=t(b);return f.model(n,s.MPost).find({md5:e.md5}).then((function(e){return c.info("Searching "+b.md5.substr(-4,4)+" in "+n),c.info(e.length,e.map((function(e){return e._doc?e._doc.md5.substr(-4,4):"not found!"}))),e.length>0}),(function(e){return c.error(e)}))}var u,h,v,b,y,_,m,w,S,x;return o(this,(function(r){switch(r.label){case 0:return u=e.chat.id,h=0,v=0,y=[],_=l.getAll(),m=function(e){h===e.length-1&&n();var t=e[h];return h++,t},[4,n()];case 1:r.sent(),w=!1,r.label=2;case 2:return[4,i(b=m(y))];case 3:if(w=r.sent(),v>3)return d.sendMessage(u,"`WARNING!` Maximum cycle count reached. You need to make search scope wider!").catch((function(e){return c.error(e)})),[2];r.label=4;case 4:if(w)return[3,2];r.label=5;case 5:return S=t(b),x=f.model(S,s.MPost),[4,new x({md5:b.md5,url:b.file_url,added_at:(new Date).toUTCString(),tags:b.tag_string,artists:b.tag_string_artist}).save((function(e){if(e)return d.sendMessage(u,"`WARNING!` Unable to save post to DB. Post was not posted!").catch((function(e){return c.error(e)})),c.error(e);d.sendPhoto(g,b.large_file_url,{caption:b.md5+"."+b.file_ext}).then((function(){var e=" \n\n            ‚úÖ Picture "+b.md5+" was posted. \n \n            üìã To collection: "+S+". \n\n            üîÅ Cycles performed: "+v+". \n \n            Selected picture from last cycle is #"+h+" \n\n            üïì Posted at: "+(new Date).toUTCString(),n=l.getAll();Object.keys(n).length&&(e=e.concat(" \n\n‚öô With preferences: "+JSON.stringify(n)+" and increased limit to "+a.LIMIT_FOR_TAGS)),d.sendMessage(u,e).catch((function(e){return c.error(e)}))})).catch((function(e){c.error(e),d.sendMessage(u,"22\n                ‚ùå Picture "+b.md5+" was NOT posted. \n \n                üìã To collection: "+S+". \n\n                üîÅ Cycles performed: "+v+". \n \n                Selected picture from last cycle is #"+h+" \n\n                üïì Error happened at: "+(new Date).toUTCString()+" \n\n\n                REASON: "+e+" \n\n\n                \n                LOG: "+JSON.stringify(b)).catch((function(e){return c.error(e)}))}))}))];case 6:return r.sent(),[2]}}))}))}function x(e){var n=e.chat.id,t=u.parseCommand(e.text).parameters;if(t._.length)return d.sendMessage(n,"Can't perceive this parameters: "+t._.join(", ")),void A(e);delete t._;var r=function(r){var o;t.hasOwnProperty(r)&&l.allowedParams.find((function(e){return e===r}))?l.set(((o={})[r]=t[r],o)):(d.sendMessage(n,r+" parameter not allowed"),A(e))};for(var o in t)r(o);d.sendMessage(n,"Dan preference now: "+JSON.stringify(l.getAll()))}function A(e){d.sendMessage(e.chat.id,"\n        Available commands:\n            /start - shows keyboard, starts bot\n            /hello - prints message\n            /pic - gets random picture\n            /post - posts picture to channel based on preferences\n            /set - sets preference\n                --rating - saves selected rating ['explicit' | 'safe' | 'questionable']; ex: /set --rating=safe\n                --order - saves selected order ['rank' | 'custom' | 'comment_bumped']; ex: /set --order=rank\n                --frequency - how often post will be posted automatically (in hours);  ex: /set --frequency=1\n    ")}n.c_start=v,n.c_hello=b,n.c_echo=y,n.c_info=_,n.c_link=m,n.c_pic=w,n.c_post=S,n.c_set=x,n.c_help=A,h("set",(function(e){x(e)}),!0),h("help",(function(e){A(e)})),h("post",(function(e){S(e)})),h("pic",(function(e){w(e)})),h("link",(function(e){m(e)})),h("hello",(function(e){b(e)})),h("info",(function(e){_(e)})),h("start",(function(e){v(e)})),h("echo",(function(e){y(e)}))},function(e,n){e.exports=require("mongoose")},function(e,n,t){"use strict";var r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var o in n=arguments[t])Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);return e}).apply(this,arguments)};n.__esModule=!0;var o=t(9),s=t(10),i=function(e){void 0===e&&(e=!1),this.error=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var t=o.bgRed.black("[DAN] >> Error: "),r=e.shift(),s=new Error(r),i=s.stack.split("\n");console.error("\n\nLogs: "+s.stack+"\n\n"),console.error(t+" "+o.red(i[2].trim())+" "+s.message+"\n")},this.warn=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];if(this.enableLogs){var t=o.bgYellow.black("[DAN] >> Warning: ");console.warn(t,o.yellow.apply(o,e))}},this.info=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];if(this.enableLogs){var t=o.bgCyan.black("[DAN] >> FYI: ");console.info(t,o.cyan.apply(o,e))}},this.enableLogs=e};n.DanConsole=i;var a=function(){function e(){}return e.prototype.flattenArrayOfObjects=function(e){var n=this;return e.reduce((function(e,t){if(Array.isArray(t))return e.concat(n.flattenArrayOfObjects(t));if("object"==typeof t){var r=[];for(var o in t){if("object"==typeof t[o])return e.concat(n.flattenArrayOfObjects([t[o]]));r.push(o+": "+t[o])}return e.concat(r)}return e.concat(t)}),[])},e.prototype.parseCommand=function(e){var n=e.split(" ");return{base:n.shift(),parameters:s(n)}},e}();n.DanUtils=a;var c=function(){function e(){this.allowedParams=["rating","order","frequency"]}return e.prototype.set=function(e){var n,t=this.getAll(),o=Object.keys(e)[0];console.log("Saving: ",o,e[o]),process.env.DAN_SETTING=JSON.stringify(r(r({},t),((n={})[o]=e[o],n)))},e.prototype.get=function(e){return JSON.parse(process.env.DAN_SETTING)[e]},e.prototype.getAll=function(){return console.log("Getting all: ",process.env.DAN_SETTING),process.env.DAN_SETTING?JSON.parse(process.env.DAN_SETTING):{}},e}();n.DanMemory=c},function(e,n,t){"use strict";n.__esModule=!0,n.EXCLUDED_TAGS=["gay","gore","yaoi","male_masturbation","male_pubic_hair","multiple_boys","otoko_no_ko"],n.TRANSLATED_TAGS_RU={},n.LIMIT_FOR_TAGS=100},function(e,n,t){var r=new(t(11))(process.env.BOT_TOKEN,{polling:!0}),o="mongodb+srv://"+process.env.DB_USERNAME+":"+process.env.DB_PASSWORD+"@"+process.env.DB_SHARDS+"/"+process.env.DB_NAME+"?retryWrites=true&w=majority",s=t(1);s.connect(o,{useUnifiedTopology:!0,useNewUrlParser:!0}).catch((function(e){console.error("[DAN] >> Error: failed to connect to Mongo DB! \n",e)}));var i=s.connection;i.on("error",(function(e){return console.error("[DAN] >> Error: Mongo DB failed \n",e)})),i.once("open",(function(){return console.info("Connected to Mongoose DB!")})),e.exports={bot:r,db:i}},function(e,n,t){"use strict";n.__esModule=!0;var r=t(6),o=t(7),s=r();t(0);var i=t(0);s.use(o.json()),s.use(o.urlencoded({extended:!0})),s.post("/api/server",(function(e,n){(console.log("req.path",e.path),e.body)&&function(e){switch(console.log("Received Text: ",e.text),e.text){case"/hello":i.c_hello(e);break;case"/start":i.c_start(e);break;case"/echo":var n="https://api.telegram.org/bot"+process.env.BOT_TOKEN+"/sendMessage";console.log("Sending message to bot nativelly!",n),s.post(n,{chat_id:e.chat.id,text:"You said: "+e.text}).then((function(e){console.log("Message posted"),e.status(200).end("ok")})).catch((function(e){console.error("UPERSERIOUS ERROR OCCURED",e)})),console.log("executing c_echo ...."),i.c_echo(e);break;default:console.log("Unable to recognise command!")}}(e.body.message);n.send("Hello from /api/server!")})),s.listen(process.env.PORT||5e3,(function(){return console.log("Telegram bot is listening on port "+(process.env.PORT||5e3)+"!")}))},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("body-parser")},function(e,n,t){"use strict";n.__esModule=!0;var r=new(t(1).Schema)({md5:String,url:String,added_at:String,tags:String,artists:String});n.MPost=r},function(e,n){e.exports=require("chalk")},function(e,n){e.exports=require("minimist")},function(e,n){e.exports=require("node-telegram-bot-api")},function(e,n,t){"use strict";var r=this&&this.__awaiter||function(e,n,t,r){return new(t||(t=Promise))((function(o,s){function i(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(i,a)}c((r=r.apply(e,n||[])).next())}))},o=this&&this.__generator||function(e,n){var t,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;i;)try{if(t=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=n.call(e,i)}catch(e){s=[6,e],r=0}finally{t=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};n.__esModule=!0;var s=t(2),i=t(3),a=new s.DanConsole(!0);console.log("[DAN] >> Starting booru.js ...");var c=t(13),u=t(14),l=t(15),f=new c;function d(e){var n=l.readdirSync("./saves"),t=++n.length;e&&Array.isArray(e)&&e.forEach((function(e){var r=e.md5+"."+e.file_ext;n.filter((function(e){return e===r})).length&&console.warn('[DAN] >> File "'+r+'" already exists! Rewriting.'),console.log("[DAN] >> Saving file #"+t+' - "'+r+'" ...');var o=f.url(e.file_url);u.get(o,(function(e){e.pipe(l.createWriteStream("./saves/"+r)),console.log("The file has been saved!")}))}))}n.getPostsInfo=function(e){var n;if(e){var t=[];for(var r in e)t.push(r+":"+e[r]);n={tags:t.join(" "),limit:i.LIMIT_FOR_TAGS},a.info("Parameters for searching: "),console.dir(n)}else a.warn("[DAN] >> @getFile(): getting random picture ...");return f.posts(n).then((function(e){if(!1!==e.success)return e;a.error("[DAN] >> Error @getFile(): "+e.message)}))},n.getPostsFileStream=function(e){return e.map((function(e){var n=f.url(e.file_url);return u.get(n).on("error",(function(e){console.log(e)}))}))},n.saveFile=d,console.log("[DAN] >> main() execution...","\n\n\n"),function(){r(this,void 0,void 0,(function(){return o(this,(function(e){return[2]}))}))}()},function(e,n){e.exports=require("danbooru")},function(e,n){e.exports=require("https")},function(e,n){e.exports=require("fs")},function(e,n,t){"use strict";n.__esModule=!0,process.env.NTBA_FIX_319="1";var r=t(2),o=t(4).bot;new r.DanConsole(!0).info("Core initiated. Loading dependencies ..."),e.exports={setCommand:function(e,n,t){void 0===t&&(t=!1);var r=t?new RegExp("/"+e+" (.+)"):new RegExp("/"+e);o.onText(r,n)}},t(0)}]);
//# sourceMappingURL=server.js.map